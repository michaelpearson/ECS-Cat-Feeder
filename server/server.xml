<?xml version="1.0" ?>
<project name="Build Server" default="war">

    <property environment="env"/>

    <path id="compile.classpath">
        <fileset dir="${basedir}/lib/">
            <include name="*.jar"/>
        </fileset>
    </path>

    <target name="clean">
        <delete dir="${basedir}/out" />
    </target>

    <target name="init" depends="clean">
        <mkdir dir="${basedir}/out/classes"/>
        <condition property="port" value="${env.PORT}" else="8080">
            <isset property="env.PORT" />
        </condition>
    </target>

    <target name="compile" depends="init" >
        <javac destdir="${basedir}/out/classes/" debug="true" includeantruntime="0" srcdir="${basedir}/src/">
            <classpath refid="compile.classpath"/>
        </javac>
        <unzip dest="${basedir}/out/classes">
            <fileset dir="${basedir}/lib/">
                <include name="**/*.jar" />
                <exclude name="webapp-runner-8.0.18.0-M1.jar" />
            </fileset>
        </unzip>
    </target>

    <target name="war" depends="compile">
        <war destfile="out/dist.war" webxml="${basedir}/web/WEB-INF/web.xml">
            <fileset dir="${basedir}/web/"/>
            <classes dir="${basedir}/out/classes"/>
        </war>
        <delete dir="${basedir}/out/classes" />
    </target>

    <target name="install"/>

    <target name="run" depends="war, seed">
        <echo message="Running" />
        <java jar="${basedir}/lib/webapp-runner-8.0.18.0-M1.jar" fork="true">
            <sysproperty key="config-file" value="${basedir}/herokuconfiguration.json" />
            <arg value="--expand-war" />
            <arg value="${basedir}/out/dist.war" />
            <arg value="--port" />
            <arg value="${port}" />
        </java>
    </target>

    <target name="seed" depends="compile">
        <java classname="catfeeder.db.DatabaseClient">
            <sysproperty key="config-file" value="${basedir}/herokuconfiguration.json" />
            <classpath path="${basedir}/out/classes" />
        </java>
    </target>

    <target name="make-password" depends="compile">
        <java classname="catfeeder.Passwords">
            <sysproperty key="config-file" value="${basedir}/herokuconfiguration.json" />
            <classpath path="${basedir}/out/classes" />
        </java>
    </target>
</project>